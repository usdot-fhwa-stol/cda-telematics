version: "3.4"
services:
  rosbag2_processing_service:
    build:
          context: ./telematic_historical_data_processing
          dockerfile: Dockerfile
          network: host
    image: usdotfhwastoldev/telematic_historical_data_processing:develop
    network_mode: host
    logging:
      options:
        max-size: "2g"
        max-file: "1"
    container_name: rosbag2_processing_service
    volumes:
           - /opt/telematics:/opt/telematics
    environment:
    - TOPIC_EXCLUSION_LIST=${ROS2_TOPIC_EXCLUSION_LIST}
    - NATS_SERVER_IP_PORT=${NATS_SERVER_IP_PORT}
    - LOG_LEVEL=debug
    - LOG_NAME=rosbag2_processing_service
    - LOG_PATH=/opt/telematics/logs
    - LOG_ROTATION_SIZE_BYTES=2147483648
    - LOG_HANDLER_TYPE=console
    - INFLUX_BUCKET=${INFLUXDB_DEV_INIT_BUCKET}
    - INFLUX_ORG=${INFLUXDB_DEV_ORG}
    - INFLUX_TOKEN=${DOCKER_INFLUXDB_INIT_ADMIN_TOKEN}
    - INFLUX_URL=${INFLUX_URL}
    - MYSQL_HOST=${DB_HOST} #Add host IP where mysql database is hosted
    - MYSQL_PORT=${DB_PORT}
    - MYSQL_DB=${GRAFANA_DB} # Name of Mysql databse
    - MYSQL_USER=${DB_USER} # Login credentials for mysql database, User
    - MYSQL_PASSWORD=${DB_PASSWORD} # Login credentials for mysql database, Password
    - MYSQL_TABLE=file_infos
    - UPLOAD_DESTINATION_PATH=${UPLOAD_DESTINATION_PATH} # For cloud deployment:This is the directory S3 bucket is mounted
    - TO_STR_FIELDS=${TO_STR_FIELDS}
    - IGNORE_FIELDS=${IGNORE_FIELDS}
    - FILE_PROCESSING_SUBJECT=ui.file.*
    - ACCEPTED_FILE_EXTENSIONS=[".mcap"]
    command: bash -c 'source /ws/install/setup.bash && ros2 run rosbag2_processing_service main'