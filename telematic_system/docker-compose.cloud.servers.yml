version: "3"
services:
  nats:
    image: 'nats:2.7.3-alpine3.15'
    container_name: nats
    restart: always
    logging:
      options:
        max-size: "2g"
        max-file: "1"
    network_mode: host

  messaging_server:
    build:
      context: "./telematic_cloud_messaging"
    container_name: messaging_server
    #Todo: The cloud messaging service image has incorrect configuration. Please update the application.properties, and build it from source code.
    image: usdotfhwastoldev/telematic_cloud_messaging:develop
    depends_on:
      - nats
    restart: always
    logging:
      options:
        max-size: "2g"
        max-file: "1"
    network_mode: host
    command: bash -c 'wait-for-it localhost:4222 && java -jar /telematic_cloud_messaging/app.jar'
    environment:
      - MESSAGING_NATS_URL=${MESSAGING_NATS_URL}
      - MESSAGING_NATS_MAX_RECONNECTS=${MESSAGING_NATS_MAX_RECONNECTS}
      - MESSAGING_INFLUX_BUCKET_TYPE=${MESSAGING_INFLUX_BUCKET_TYPE}
      - MESSAGING_INFLUX_URI=${MESSAGING_INFLUX_URI}
      - MESSAGING_INFLUX_PORT=${MESSAGING_INFLUX_PORT}
      - MESSAGING_INFLUX_USERNAME=${MESSAGING_INFLUX_USERNAME}
      - MESSAGING_INFLUX_PWD=${MESSAGING_INFLUX_PWD}
      - MESSAGING_INFLUX_BUCKET_STREETS=${MESSAGING_INFLUX_BUCKET_STREETS}
      - MESSAGING_STREETS_SUBSCRIPTION_TOPIC=${MESSAGING_STREETS_SUBSCRIPTION_TOPIC}
      - MESSAGING_INFLUX_BUCKET_PLATFORM=${MESSAGING_INFLUX_BUCKET_PLATFORM}
      - MESSAGING_PLATFORM_SUBSCRIPTION_TOPIC=${MESSAGING_PLATFORM_SUBSCRIPTION_TOPIC}
      - MESSAGING_INFLUX_BUCKET_CLOUD=${MESSAGING_INFLUX_BUCKET_CLOUD}
      - MESSAGING_CLOUD_SUBSCRIPTION_TOPIC=${MESSAGING_CLOUD_SUBSCRIPTION_TOPIC}
      - MESSAGING_NUMBER_TOPICS_PER_DISPATCHER=${MESSAGING_NUMBER_TOPICS_PER_DISPATCHER}
      - MESSAGING_VEHICLE_UNIT_ID_LIST=${MESSAGING_VEHICLE_UNIT_ID_LIST}
      - MESSAGING_STREETS_UNIT_ID_LIST=${MESSAGING_STREETS_UNIT_ID_LIST}
      - MESSAGING_CLOUD_UNIT_ID_LIST=${MESSAGING_CLOUD_UNIT_ID_LIST}
      - MESSAGING_INFLUX_ORG=${MESSAGING_INFLUX_ORG}
      - MESSAGING_INFLUX_TOKEN=${MESSAGING_INFLUX_TOKEN}
      - MESSAGING_TO_STR_FIELDS=${MESSAGING_TO_STR_FIELDS}
      - MESSAGING_IGNORE_FIELDS=${MESSAGING_IGNORE_FIELDS}
      - MESSAGING_INFLUX_CONNECT_TIMEOUT=${MESSAGING_INFLUX_CONNECT_TIMEOUT}
      - MESSAGING_INFLUX_WRITE_TIMEOUT=${MESSAGING_INFLUX_WRITE_TIMEOUT}
      - MESSAGING_DB_DRIVER=${MESSAGING_DB_DRIVER}
      - MESSAGING_DB_URL=${MESSAGING_DB_URL}
      - MESSAGING_DB_USERNAME=${MESSAGING_DB_USERNAME}
      - MESSAGING_DB_PASSWORD=${MESSAGING_DB_PASSWORD}
      - MESSAGEING_DB_DIALECT=${MESSAGEING_DB_DIALECT}
      - MESSAGING_LOGGING_LEVEL=${MESSAGING_LOGGING_LEVEL}
